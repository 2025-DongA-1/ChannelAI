name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: '배포 대상 선택'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - was
          - web

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # 빌드 & 테스트
  # ============================================
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: TypeScript build
        working-directory: ./backend
        run: npx tsc --noEmit

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Frontend build
        working-directory: ./frontend
        run: npm run build

  # ============================================
  # WAS 서버 배포 (수동 트리거에서만 실행)
  # ============================================
  deploy-was:
    needs: [build, deploy-web]
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'was')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to WAS server via SSH (WEB 경유)
        uses: appleboy/ssh-action@v1.0.3
        with:
          # WAS (Private Subnet) 접속 정보
          host: ${{ secrets.WAS_HOST }}
          username: root
          key: ${{ secrets.WAS_SSH_KEY }}
          port: 22
          # WEB (Public) 서버를 Proxy로 경유
          proxy_host: ${{ secrets.WEB_HOST }}
          proxy_username: root
          proxy_key: ${{ secrets.WEB_SSH_KEY }}
          proxy_port: 22
          command_timeout: 10m
          script: |
            set -e

            # ========== 1. Node.js 설치 (없으면) ==========
            if ! command -v node &> /dev/null; then
              echo ">> Node.js 설치 중..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi
            echo "Node.js: $(node -v), npm: $(npm -v)"

            # ========== 2. PM2 설치 (없으면) ==========
            if ! command -v pm2 &> /dev/null; then
              echo ">> PM2 설치 중..."
              npm install -g pm2
            fi

            # ========== 3. Git 설치 (없으면) ==========
            if ! command -v git &> /dev/null; then
              echo ">> Git 설치 중..."
              apt-get update && apt-get install -y git
            fi

            # ========== 4. 프로젝트 디렉토리 준비 ==========
            APP_DIR="/opt/marketing-platform"
            
            if [ -d "$APP_DIR/.git" ]; then
              echo ">> git pull..."
              cd $APP_DIR
              git fetch origin
              git reset --hard origin/main
            else
              echo ">> 최초 clone..."
              rm -rf $APP_DIR
              git clone https://github.com/2025-DongA-1/ChannelAI.git $APP_DIR
            fi

            cd $APP_DIR/backend

            # ========== 5. 환경변수 설정 ==========
            cat > .env << 'ENVEOF'
PORT=3000
DB_HOST=${{ secrets.DB_HOST }}
DB_PORT=${{ secrets.DB_PORT }}
DB_NAME=${{ secrets.DB_NAME }}
DB_USER=${{ secrets.DB_USER }}
DB_PASSWORD=${{ secrets.DB_PASSWORD }}
JWT_SECRET=${{ secrets.JWT_SECRET }}
NODE_ENV=production
FRONTEND_URL=https://channelai.kro.kr
AI_PROVIDER=groq
GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
EMAIL_FROM=report@channelai.kro.kr
ENABLE_DAILY_REPORT=false
KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
KAKAO_REDIRECT_URI=https://channelai.kro.kr/api/v1/auth/kakao/callback
NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
NAVER_REDIRECT_URI=https://channelai.kro.kr/api/v1/auth/naver/callback
GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
GOOGLE_REDIRECT_URI=https://channelai.kro.kr/api/v1/auth/google/callback
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
ENVEOF
            # ========== 6. 의존성 설치 & 빌드 ==========
            npm ci --production=false
            npx tsc

            # ========== 7. PM2 시작/재시작 ==========
            cd $APP_DIR
            pm2 delete marketing-api 2>/dev/null || true
            pm2 start deploy/ecosystem.config.js
            pm2 save

  # ============================================
  # WEB 서버 배포 (수동 트리거에서만 실행)
  # ============================================
  deploy-web:
    needs: build
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'web')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Deploy to WEB server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WEB_HOST }}
          username: root
          key: ${{ secrets.WEB_SSH_KEY }}
          port: 22
          script: |
            # Nginx 정적 파일 업데이트
            rm -rf /var/www/marketing-platform/*

      - name: Copy build to WEB server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.WEB_HOST }}
          username: root
          key: ${{ secrets.WEB_SSH_KEY }}
          port: 22
          source: "frontend/dist/*"
          target: "/var/www/marketing-platform/"
          strip_components: 2

      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WEB_HOST }}
          username: root
          key: ${{ secrets.WEB_SSH_KEY }}
          port: 22
          script: |
            sudo nginx -t && sudo systemctl reload nginx
