name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: '배포 대상 선택'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - was
          - web

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # 빌드 & 테스트
  # ============================================
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: TypeScript build
        working-directory: ./backend
        run: npx tsc --noEmit

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Frontend build
        working-directory: ./frontend
        run: npm run build

  # ============================================
  # WAS 서버 배포 (수동 트리거에서만 실행)
  # ============================================
  deploy-was:
    needs: [build]
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'was')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to WAS via WEB server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WEB_HOST }}
          username: root
          key: ${{ secrets.WEB_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e

            APP_DIR="/opt/marketing-platform"

            # ========== 1. WEB 서버에서 최신 코드 pull ==========
            if [ -d "$APP_DIR/.git" ]; then
              echo ">> git pull..."
              cd $APP_DIR
              git fetch origin
              git reset --hard origin/main
            else
              echo ">> 최초 clone..."
              rm -rf $APP_DIR
              git clone https://github.com/2025-DongA-1/ChannelAI.git $APP_DIR
            fi

            # ========== 2. WAS 서버로 코드 복사 ==========
            echo ">> WAS 서버로 코드 복사 중..."
            rsync -av --delete \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='frontend' \
              $APP_DIR/ root@10.10.10.7:/opt/marketing-platform/

      - name: Setup WAS server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WAS_HOST }}
          username: root
          key: ${{ secrets.WAS_SSH_KEY }}
          port: 22
          proxy_host: ${{ secrets.WEB_HOST }}
          proxy_username: root
          proxy_key: ${{ secrets.WEB_SSH_KEY }}
          proxy_port: 22
          command_timeout: 10m
          script: |
            set -e

            # ========== 1. Node.js 설치/업그레이드 ==========
            NODE_MAJOR=$(node -v 2>/dev/null | cut -d'.' -f1 | tr -d 'v' || echo "0")
            if [ "$NODE_MAJOR" -lt 20 ]; then
              echo ">> Node.js 20 설치 중... (현재: $(node -v 2>/dev/null || echo '없음'))"
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi
            echo "Node.js: $(node -v), npm: $(npm -v)"

            # ========== 2. PM2 설치 (없으면) ==========
            if ! command -v pm2 &> /dev/null; then
              echo ">> PM2 설치 중..."
              npm install -g pm2
            fi

            cd /opt/marketing-platform/backend

            # ========== 3. 환경변수 설정 (.env 로컬과 동일 구조) ==========
            cat > .env << 'ENVEOF'
            PORT=3000
            # --- External DB ---
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            # --- Local DB (비활성화 - 서버는 외부DB 사용) ---
            #DB_HOST=localhost
            #DB_PORT=3306
            #DB_NAME=ad_mate_db
            #DB_USER=root
            #DB_PASSWORD=1234

            # --- Common Config ---
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            NODE_ENV=production
            FRONTEND_URL=https://channelai.kro.kr
            # Python 실행 경로 (서버 환경)
            PYTHON_PATH=/usr/bin/python3

            # AI Analysis Config
            # AI_PROVIDER: 'groq' (무료★), 'gemini' (무료), 'openai' (유료)
            AI_PROVIDER=groq

            # Groq (무료 - 현재 사용 중) → https://console.groq.com/keys
            GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}

            # Google Gemini (무료) → https://aistudio.google.com/apikey
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}

            # OpenAI GPT (유료 - 나중에 사용 시 AI_PROVIDER=openai 로 변경)
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

            # --- Email Report Config ---
            # Resend API (추천): https://resend.com/api-keys 에서 발급
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            # 발신 이메일 주소 (도메인 인증된 주소만 가능)
            EMAIL_FROM=report@channelai.kro.kr
            # 일간 리포트 활성화 여부 (false=주간만, true=매일+주간)
            ENABLE_DAILY_REPORT=true

            # Social Login - Kakao
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_REDIRECT_URI=https://channelai.kro.kr/api/v1/auth/kakao/callback

            # Social Login - Naver
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            NAVER_REDIRECT_URI=https://channelai.kro.kr/api/v1/auth/naver/callback

            # Social Login - Google
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=https://channelai.kro.kr/api/v1/auth/google/callback

            # Ad Platform - Karrot
            KARROT_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KARROT_REDIRECT_URI=https://channelai.kro.kr/api/v1/auth/karrot/callback

            # Redis
            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_PASSWORD=
            ENVEOF

            # ========== 4. 의존성 설치 & 빌드 ==========
            npm install --include=dev --no-audit --no-fund
            npx tsc

            # ========== 5. PM2 시작/재시작 ==========
            cd /opt/marketing-platform
            pm2 delete marketing-api 2>/dev/null || true
            pm2 start deploy/ecosystem.config.js
            pm2 save

  # ============================================
  # WEB 서버 배포 (수동 트리거에서만 실행)
  # ============================================
  deploy-web:
    needs: build
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'web')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Deploy to WEB server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WEB_HOST }}
          username: root
          key: ${{ secrets.WEB_SSH_KEY }}
          port: 22
          script: |
            # Nginx 정적 파일 업데이트
            rm -rf /opt/marketing-platform/frontend/dist/*

      - name: Copy build to WEB server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.WEB_HOST }}
          username: root
          key: ${{ secrets.WEB_SSH_KEY }}
          port: 22
          source: "frontend/dist/*"
          target: "/opt/marketing-platform/frontend/dist/"
          strip_components: 2

      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WEB_HOST }}
          username: root
          key: ${{ secrets.WEB_SSH_KEY }}
          port: 22
          script: |
            sudo nginx -t && sudo systemctl reload nginx
